const collectionName_user = 'user';  //login/create
const mongoose = require('mongoose');
const db = mongoose.connection;
const uri = `mongodb+srv://billydeng97:dhy97886886@cluster0.zsgzyzj.mongodb.net/381Project?retryWrites=true&w=majority`;


const express = require('express');
const session=require('cookie-session');

const app=express();
app.set('view engine','ejs');
const bodyParser=require('body-parser');
app.use(bodyParser.urlencoded({ extended: true }));



const matchNamePW = async (db,usn,psw) => {
   try {
      let result = await db.collection(collectionName_user).findOne({ "username":`${usn}`, "password":`${psw}`});
      return result !== null;
   }
   
   catch (err) {
      console.error('Failed to query MongoDB:', err);
      return false;
   }
   
   }
   
   
   
   
   const handle_login = async (username, password) => {
   
   try{ 
 
    mongoose.connect(uri);//mongoose method(cnDB)
   
   let result=await matchNamePW(db,username,password);
   if(result){console.log("Wah 666")}
   else{console.log("Damn!!!")}
   
   console.log(result);
  }
   catch (err){
   console.error("Damn",err);
   }
  finally{
   await db.close();
   
   
   }
   
   }
   
app.get('/login', (req, res) => {
   res.status(200).render('login',{});
});

app.post('/login', (req,res) => {
   handle_login(req.body.username,req.body.password);
});

app.listen(process.env.PORT || 3000);
